// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id         String       @id @default(cuid())
  name       String
  email      String?
  phone      String?
  notes      String?
  vehicles   Vehicle[]
  estimates  Estimate[]
  workOrders WorkOrder[]
  createdAt  DateTime     @default(now())
}

model Vehicle {
  id         String    @id @default(cuid())
  customer   Customer  @relation(fields: [customerId], references: [id])
  customerId String
  make       String
  model      String
  year       Int?
  color      String?
  plate      String    @unique
  vin        String?
  km         Int?
  estimates  Estimate[]
  workOrders WorkOrder[]
  createdAt  DateTime  @default(now())

  @@index([vin])
}

model Estimate {
  id          String         @id @default(cuid())
  number      String         @unique
  customer    Customer       @relation(fields: [customerId], references: [id])
  customerId  String
  vehicle     Vehicle        @relation(fields: [vehicleId], references: [id])
  vehicleId   String
  status      EstimateStatus @default(DRAFT)
  items       EstimateItem[]
  subtotal    Decimal        @default(0)
  vat         Decimal        @default(0)
  total       Decimal        @default(0)
  notes       String?
  createdAt   DateTime       @default(now())
  sentAt      DateTime?
  acceptedAt  DateTime?
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

model EstimateItem {
  id          String   @id @default(cuid())
  estimate    Estimate @relation(fields: [estimateId], references: [id])
  estimateId  String
  kind        ItemKind @default(SERVICE)
  description String
  qty         Decimal  @default(1)
  unitPrice   Decimal  @default(0)
  lineTotal   Decimal  @default(0)

  @@index([estimateId])
}

enum ItemKind {
  SERVICE
  PART
  LABOR
}

model WorkOrder {
  id          String      @id @default(cuid())
  number      String      @unique
  customer    Customer    @relation(fields: [customerId], references: [id])
  customerId  String
  vehicle     Vehicle     @relation(fields: [vehicleId], references: [id])
  vehicleId   String
  status      WorkStatus  @default(CHECKED_IN)
  kmIn        Int?
  notes       String?
  createdAt   DateTime    @default(now())
  deliveredAt DateTime?
  items       WorkOrderItem[]
}

enum WorkStatus {
  CHECKED_IN
  DIAGNOSIS
  IN_REPAIR
  READY
  DELIVERED
}

model WorkOrderItem {
  id          String    @id @default(cuid())
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
  workOrderId String
  kind        ItemKind  @default(SERVICE)
  description String
  qty         Decimal   @default(1)
  unitPrice   Decimal   @default(0)
  lineTotal   Decimal   @default(0)
}
